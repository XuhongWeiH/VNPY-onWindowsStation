# 本地模拟交易模块（PaperAccount)

&nbsp;

该模块主要为了解决目前各类需要依赖服务端功能的仿真交易账户的问题，例如：



1. SimNow的CTP仿真环境，从2019年之后**稳定性就逐渐变差**，时不时会出现宕机连不上，或者和实盘行情出现较大的偏差；

2. 截至目前，国内期权方面始终没有类似SimNow能提供实盘行情撮合的仿真环境：

   a. 期货期权用的交易所大仿真环境**需要有用户报单才有行情**（类似实盘的独立环境）；

   b. ETF期权用的经纪商自建仿真环境，存在着**行情延时**和**不根据盘口撮合**等问题；

4. 许多数字货币交易所的Testnet仿真账户**给的初始资金太少**，用完了想要充值还要**通过外部的链上获取代币**。



对于上述这类问题，最简单的解决方案就是直接在交易客户端内部提供一套本地化的模拟交易环境，同时基于实盘行情的盘口数据进行委托撮合，也就是PaperAccount本地模拟交易模块。



该模块在使用上非常傻瓜，首先在VN Station中加载PaperAccount模块，以及想要进行模拟交易的接口（下图中选的火币期货）：




![](https://static.vnpy.com/upload/temp/9ff141d4-ca1d-46e4-9068-f07e662e48f6.png)




启动VN Trader后，连接登录交易接口。点击菜单栏的【帮助】->【合约查询】，在弹出的对话框中直接点击右上角的【查询】按钮，发现所有合约的交易接口列均显示为PAPER：





![](https://static.vnpy.com/upload/temp/0a919914-0b85-44d8-b5e6-5f551ecea014.png)



**此时所有合约的交易委托和撤单请求均已被PaperAccount模块接管，不会再发往实盘服务器，可以放心大胆的进行各种交易测试了。**



关闭合约信息对话框，回到主界面先订阅某一合约的行情（注意一定要订阅），再进行常规的下单和撤单操作：





![](https://static.vnpy.com/upload/temp/1a1c139c-0f32-4ad2-9f9f-65b321780fb0.png)



上图中委托、成交、持仓三个监控组件中显示的信息，其接口列均显示为PAPER（本地模拟的数据)。这里列出PaperAccount模块在使用中的一些业务逻辑要点：



- 支持的委托类型（不支持的类型会被拒单）：

  - 限价单；
  - 市价单；
  - 停止单；

- 委托撮合规则采用**到价成交**模式，以买入委托为例：

  - 限价单：当盘口卖1价ask_price_1小于等于委托价格，则成交；
  - 停止单：当盘口卖1价ask_price_1大于等于委托价格，则成交；

- 委托成交时**不考虑盘口挂单量**，一次性全部成交；

- 成交后，先推送委托状态更新OrderData，再推送成交信息TradeData，**和实盘交易中的顺序一致**；

- 委托成交后，模块会自动记录相应的持仓信息PositionData：

  - 根据合约本身的持仓模式（多空仓 vs 净仓位）信息，维护对应的持仓信息，如上图中火币期货就是多空仓模式；
  - **开仓成交时，采用加权平均计算更新持仓成本价；**
  - **平仓成交时，持仓成本价不变；**
  - 多空仓模式下，挂出平仓委托后会冻结相应的持仓数量，可用数量不足时会拒单；
  - 持仓的盈亏会基于持仓成本价和最新成交价定时计算（默认频率1秒）；

- 数据的持久化保存：

  - 成交数据和委托数据不保存，关闭VN Trader后即消失；
  - 持仓数据会在有变化时**立即写入硬盘文件**，重启VN Trader登录交易接口后即可看到（要收到相应的合约信息）。



点击菜单栏的【功能】->【模拟交易】，在打开的对话框中可以对PaperAccount模块的功能进行若干配置：





![](https://static.vnpy.com/upload/temp/da81c648-f45b-476a-9327-d2a41b875acc.png)



- 成交滑点：用于影响市价单和停止单成交时，成交价格相对于盘口价格的**滑点跳数**；
- 计算频率：多少秒执行一次持仓盈亏计算更新，如果持仓较多时发现程序卡顿，建议尝试调低频率；
- 立即撮合：默认情况下，用户发出的委托需要**等到下一个TICK盘口推送才会撮合**（模拟实盘情景），对于TICK推送频率较低的不活跃合约可以勾选该选项，委托后会**立即基于当前的最新TICK盘口撮合**；
- 清空所有持仓按钮，顾名思义用于把所有本地持仓数据一键清空。



PaperAccount模块同样也可以配合vn.py内部的所有其他策略应用模块一起使用（如CtaStrategy、SpreadTrading等），从而实现完全本地化的量化策略仿真交易测试。


